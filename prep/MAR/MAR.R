
library(readxl)
library(dplyr)
library(tidyr)
library(reshape2)
library(readr)

scen_year <- layers$data$scenario_year

mar_sust <- SelectLayersData(layers, layers='mar_sustainability_scores') %>%
  dplyr::select( rgn_id = "id_num",  species = "category", sust_coeff ="val_num")


mar_harvest <- SelectLayersData(layers, layers='mar_harvest_tonnes') %>%
  dplyr::select(rgn_id = "id_num",species = "category", year, tonnes = "val_num")


c1<- merge(mar_harvest, mar_sust)

# 4-year rolling mean of data
c2 <- c1 %>%
  dplyr::group_by(rgn_id, species) %>%
  dplyr::arrange(rgn_id, species, year) %>%
  dplyr::mutate(sm_tonnes = zoo::rollapply(tonnes, 4, mean, na.rm = TRUE, partial =
                                             TRUE, align = "right")) %>%
  dplyr::ungroup()

##Punto de referencia
pto_ref<- c2 %>% group_by(rgn_id, species) %>%
  dplyr::summarise(pto_max = max(sm_tonnes))%>%
  dplyr::group_by(rgn_id) %>%
  dplyr::summarise(pto_ref = sum(pto_max)) %>%
  dplyr::mutate(Punto_ref = pto_ref*0.01) %>%
  dplyr::select(rgn_id, Punto_ref)

##Para calcular el estado
c3<- c2 %>%
  dplyr::filter(year %in% c(2017:2021)) %>%
  dplyr::mutate(mult = sm_tonnes* sust_coeff) %>%
  dplyr::group_by(rgn_id, year) %>%
  dplyr::mutate(YC = sum(mult)) %>%
  dplyr::select(rgn_id, year, YC)

c3<-c3[!duplicated(c3), ]


c4<- merge(c3, pto_ref)

status<-c4 %>%
  dplyr::mutate(status = YC/Punto_ref) %>%
  dplyr::select(rgn_id, year, status)

# status
status_a <- status %>%
  dplyr::filter(year == scen_year) %>%
  dplyr::mutate(dimension = "status") %>%
  dplyr::select(region_id = rgn_id, score = status, dimension)


trend_years <- (scen_year - 4):(scen_year)

trend <- CalculateTrend(status_data = status, trend_years = trend_years)


# return scores
scores = rbind(status_a, trend) %>%
  dplyr::mutate(goal = 'MAR')


